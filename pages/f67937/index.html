<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Concurrent Mode | Wsh&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/images/logo.png">
    <meta name="description" content="webå‰ç«¯æŠ€æœ¯åšå®¢,ä¸“æ³¨webå‰ç«¯å­¦ä¹ ä¸æ€»ç»“ã€‚JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,githubç­‰æŠ€æœ¯æ–‡ç« ã€‚">
    
    <link rel="preload" href="/assets/css/0.styles.bc63fb2f.css" as="style"><link rel="preload" href="/assets/js/app.a43f69ea.js" as="script"><link rel="preload" href="/assets/js/2.dc8a2400.js" as="script"><link rel="preload" href="/assets/js/57.e410f001.js" as="script"><link rel="prefetch" href="/assets/js/10.0e927a4e.js"><link rel="prefetch" href="/assets/js/11.0c7b912c.js"><link rel="prefetch" href="/assets/js/12.f8872b43.js"><link rel="prefetch" href="/assets/js/13.2799a35f.js"><link rel="prefetch" href="/assets/js/14.792f8f9e.js"><link rel="prefetch" href="/assets/js/15.da56f803.js"><link rel="prefetch" href="/assets/js/16.7ac59715.js"><link rel="prefetch" href="/assets/js/17.b8b5ac23.js"><link rel="prefetch" href="/assets/js/18.3721b0a6.js"><link rel="prefetch" href="/assets/js/19.90242a39.js"><link rel="prefetch" href="/assets/js/20.33a6b051.js"><link rel="prefetch" href="/assets/js/21.bce2654d.js"><link rel="prefetch" href="/assets/js/22.a08c5355.js"><link rel="prefetch" href="/assets/js/23.a986cb8d.js"><link rel="prefetch" href="/assets/js/24.28d6d2c0.js"><link rel="prefetch" href="/assets/js/25.98196063.js"><link rel="prefetch" href="/assets/js/26.773db660.js"><link rel="prefetch" href="/assets/js/27.7734a951.js"><link rel="prefetch" href="/assets/js/28.f5937629.js"><link rel="prefetch" href="/assets/js/29.a0036079.js"><link rel="prefetch" href="/assets/js/3.7e94d855.js"><link rel="prefetch" href="/assets/js/30.24f915c8.js"><link rel="prefetch" href="/assets/js/31.37dd5dba.js"><link rel="prefetch" href="/assets/js/32.f3f99a63.js"><link rel="prefetch" href="/assets/js/33.36699bf1.js"><link rel="prefetch" href="/assets/js/34.f7013edd.js"><link rel="prefetch" href="/assets/js/35.2e40c132.js"><link rel="prefetch" href="/assets/js/36.d55742af.js"><link rel="prefetch" href="/assets/js/37.13105919.js"><link rel="prefetch" href="/assets/js/38.5e292520.js"><link rel="prefetch" href="/assets/js/39.2320bf63.js"><link rel="prefetch" href="/assets/js/4.c704e751.js"><link rel="prefetch" href="/assets/js/40.9a526451.js"><link rel="prefetch" href="/assets/js/41.12b79363.js"><link rel="prefetch" href="/assets/js/42.449be1e8.js"><link rel="prefetch" href="/assets/js/43.4ee39152.js"><link rel="prefetch" href="/assets/js/44.f19c0ac2.js"><link rel="prefetch" href="/assets/js/45.871e787f.js"><link rel="prefetch" href="/assets/js/46.58fc807e.js"><link rel="prefetch" href="/assets/js/47.b7a40fd6.js"><link rel="prefetch" href="/assets/js/48.66177935.js"><link rel="prefetch" href="/assets/js/49.1ace55b1.js"><link rel="prefetch" href="/assets/js/5.2db75e05.js"><link rel="prefetch" href="/assets/js/50.2570317a.js"><link rel="prefetch" href="/assets/js/51.b1f6e78a.js"><link rel="prefetch" href="/assets/js/52.2a5b4377.js"><link rel="prefetch" href="/assets/js/53.29eb6dda.js"><link rel="prefetch" href="/assets/js/54.1799aa65.js"><link rel="prefetch" href="/assets/js/55.b0c2ffe3.js"><link rel="prefetch" href="/assets/js/56.8d40c0b7.js"><link rel="prefetch" href="/assets/js/58.d7a69cae.js"><link rel="prefetch" href="/assets/js/59.d46851b0.js"><link rel="prefetch" href="/assets/js/6.9073f8bb.js"><link rel="prefetch" href="/assets/js/60.3320c608.js"><link rel="prefetch" href="/assets/js/61.a22d2460.js"><link rel="prefetch" href="/assets/js/62.b3e51a77.js"><link rel="prefetch" href="/assets/js/63.6e69a2d0.js"><link rel="prefetch" href="/assets/js/64.cebb2a64.js"><link rel="prefetch" href="/assets/js/65.553e1ee3.js"><link rel="prefetch" href="/assets/js/66.c1a30645.js"><link rel="prefetch" href="/assets/js/67.2970ca5f.js"><link rel="prefetch" href="/assets/js/68.e6d6a171.js"><link rel="prefetch" href="/assets/js/69.e1a8d116.js"><link rel="prefetch" href="/assets/js/7.733f78a6.js"><link rel="prefetch" href="/assets/js/70.296e4c18.js"><link rel="prefetch" href="/assets/js/71.554ec087.js"><link rel="prefetch" href="/assets/js/72.e3444572.js"><link rel="prefetch" href="/assets/js/73.292f281b.js"><link rel="prefetch" href="/assets/js/74.5e65924a.js"><link rel="prefetch" href="/assets/js/75.ae9baee6.js"><link rel="prefetch" href="/assets/js/76.05ec40ce.js"><link rel="prefetch" href="/assets/js/77.89689004.js"><link rel="prefetch" href="/assets/js/78.785b20a2.js"><link rel="prefetch" href="/assets/js/79.021eeefc.js"><link rel="prefetch" href="/assets/js/8.c53fd8de.js"><link rel="prefetch" href="/assets/js/80.5108bf68.js"><link rel="prefetch" href="/assets/js/81.e8e01d28.js"><link rel="prefetch" href="/assets/js/82.edd6babf.js"><link rel="prefetch" href="/assets/js/9.d60910cc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bc63fb2f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/1.gif" alt="Wsh's blog" class="logo"> <span class="site-name can-hide">Wsh's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">é¦–é¡µ</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="çŸ¥è¯†ğŸ‘–" class="dropdown-title"><a href="/note/" class="link-title">çŸ¥è¯†ğŸ‘–</a> <span class="title" style="display:none;">çŸ¥è¯†ğŸ‘–</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/cache/" class="nav-link">å‰ç«¯ç¼“å­˜</a></li><li class="dropdown-item"><!----> <a href="/note/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/note/typescript/" class="nav-link">typescript</a></li><li class="dropdown-item"><!----> <a href="/note/javascript/" class="nav-link">javascript</a></li><li class="dropdown-item"><!----> <a href="/note/flutter/" class="nav-link">flutter</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å·¥ç¨‹ğŸŒ¹" class="dropdown-title"><a href="/tool/" class="link-title">å·¥ç¨‹ğŸŒ¹</a> <span class="title" style="display:none;">å·¥ç¨‹ğŸŒ¹</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/node/" class="nav-link">node</a></li><li class="dropdown-item"><!----> <a href="/tool/webpack/" class="nav-link">webpack</a></li></ul></div></div><div class="nav-item"><a href="/note/algorithm/" class="nav-link">è½»æ¾ä¸€åˆ»ğŸ˜‰</a></div><div class="nav-item"><a href="/pages/ca0c25/" class="nav-link">å®åº“ğŸ“°</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•ğŸ”’" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•ğŸ”’</a> <span class="title" style="display:none;">ç´¢å¼•ğŸ”’</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div><div class="nav-item"><a href="https://blog.fudenglong.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  é¾™å“¥çš„å¤§ğŸ‚ä¹‹è·¯
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/wshuhua" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/images/avatar.gif"> <div class="blogger-info"><h3>wsh</h3> <span>çƒ­çˆ±å‰ç«¯çš„ç¨‹åºåª›</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">é¦–é¡µ</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="çŸ¥è¯†ğŸ‘–" class="dropdown-title"><a href="/note/" class="link-title">çŸ¥è¯†ğŸ‘–</a> <span class="title" style="display:none;">çŸ¥è¯†ğŸ‘–</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/cache/" class="nav-link">å‰ç«¯ç¼“å­˜</a></li><li class="dropdown-item"><!----> <a href="/note/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/note/typescript/" class="nav-link">typescript</a></li><li class="dropdown-item"><!----> <a href="/note/javascript/" class="nav-link">javascript</a></li><li class="dropdown-item"><!----> <a href="/note/flutter/" class="nav-link">flutter</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å·¥ç¨‹ğŸŒ¹" class="dropdown-title"><a href="/tool/" class="link-title">å·¥ç¨‹ğŸŒ¹</a> <span class="title" style="display:none;">å·¥ç¨‹ğŸŒ¹</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tool/node/" class="nav-link">node</a></li><li class="dropdown-item"><!----> <a href="/tool/webpack/" class="nav-link">webpack</a></li></ul></div></div><div class="nav-item"><a href="/note/algorithm/" class="nav-link">è½»æ¾ä¸€åˆ»ğŸ˜‰</a></div><div class="nav-item"><a href="/pages/ca0c25/" class="nav-link">å®åº“ğŸ“°</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•ğŸ”’" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•ğŸ”’</a> <span class="title" style="display:none;">ç´¢å¼•ğŸ”’</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div><div class="nav-item"><a href="https://blog.fudenglong.site" target="_blank" rel="noopener noreferrer" class="nav-link external">
  é¾™å“¥çš„å¤§ğŸ‚ä¹‹è·¯
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/wshuhua" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> reactåŸºç¡€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span> reactæ›´æ–°ç‰¹æ€§</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span> reactè¿›é˜¶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c34d3a/" class="sidebar-link">react æ¶æ„æ¼”å˜</a></li><li><a href="/pages/b5b966/" class="sidebar-link">react renderé˜¶æ®µ</a></li><li><a href="/pages/f04e17/" class="sidebar-link">react commité˜¶æ®µ</a></li><li><a href="/pages/fb794b/" class="sidebar-link">react diff</a></li><li><a href="/pages/1ac33a/" class="sidebar-link">react çŠ¶æ€æ›´æ–°</a></li><li><a href="/pages/f09444/" class="sidebar-link">react hook</a></li><li><a href="/pages/f67937/" aria-current="page" class="active sidebar-link">Concurrent Mode</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-0c557b5e><div class="articleInfo" data-v-0c557b5e><ul class="breadcrumbs" data-v-0c557b5e><li data-v-0c557b5e><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-0c557b5e></a></li> <li data-v-0c557b5e><a href="/note/react/#react" data-v-0c557b5e>react</a></li><li data-v-0c557b5e><a href="/note/react/# reactè¿›é˜¶" data-v-0c557b5e> reactè¿›é˜¶</a></li></ul> <div class="info" data-v-0c557b5e><!----> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-0c557b5e><a href="javascript:;" data-v-0c557b5e>2022-04-22</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Concurrent Mode<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h3 id="_01-scheduler"><a href="#_01-scheduler" class="header-anchor">#</a> 01. scheduler</h3> <p>schedulerä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š</p> <ul><li><p>æ—¶é—´åˆ‡ç‰‡</p></li> <li><p>ä¼˜å…ˆçº§è°ƒåº¦</p></li></ul> <h4 id="æ—¶é—´åˆ‡ç‰‡åŸç†"><a href="#æ—¶é—´åˆ‡ç‰‡åŸç†" class="header-anchor">#</a> æ—¶é—´åˆ‡ç‰‡åŸç†</h4> <p>Schedulerçš„æ—¶é—´åˆ‡ç‰‡åŠŸèƒ½æ˜¯é€šè¿‡taskï¼ˆå®ä»»åŠ¡ï¼‰å®ç°çš„ã€‚
å¸¸è§çš„tastå°±æ˜¯setTimoutï¼Œä½†æ˜¯æœ‰ä¸ªtaskæ¯”setTimeoutæ‰§è¡Œæ—¶æœºæ›´é å‰ï¼Œ<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel" target="_blank" rel="noopener noreferrer">MessageChannel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>å…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é€šé“ï¼Œå¹¶é€šè¿‡å®ƒçš„ä¸¤ä¸ªMessagePort å±æ€§å‘é€æ•°æ®ã€‚</p> <p>æ‰€ä»¥Schedulerå°†éœ€è¦è¢«æ‰§è¡Œçš„å›è°ƒå‡½æ•°ä½œä¸ºMessageChannelçš„å›è°ƒæ‰§è¡Œã€‚å¦‚æœå½“å‰å®¿ä¸»ç¯å¢ƒä¸æ”¯æŒMessageChannelï¼Œå†ä½¿ç”¨setTimeoutã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>requestHostCallback = function(cb) {
  if (_callback !== null) {
    // Protect against re-entrancy.
    setTimeout(requestHostCallback, 0, cb);
  } else {
    _callback = cb;
    setTimeout(_flushCallback, 0);
  }
};
</code></pre></div><p>åœ¨Reactçš„renderé˜¶æ®µï¼Œå¼€å¯Concurrent Modeæ—¶ï¼Œæ¯æ¬¡éå†å‰ï¼Œéƒ½ä¼šé€šè¿‡Scheduleræä¾›çš„shouldYieldæ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­éå†ï¼Œä½¿æµè§ˆå™¨æœ‰æ—¶é—´æ¸²æŸ“
æ˜¯å¦ä¸­æ–­çš„ä¾æ®ï¼šæ¯ä¸ªä»»åŠ¡çš„å‰©ä½™æ—¶é—´æ˜¯å¦ç”¨å®Œã€‚åœ¨Schdedulerä¸­ï¼Œä¸ºä»»åŠ¡åˆ†é…çš„åˆå§‹å‰©ä½™æ—¶é—´ä¸º5ms</p> <div class="language- extra-class"><pre class="language-text"><code>function workLoopConcurrent() {
  while (workInProgress !== null &amp;&amp; !shouldYield()) {
    performUnitOfWork(workInProgress);
  }
}
</code></pre></div><p>é€šè¿‡fpsåŠ¨æ€è°ƒæ•´åˆ†é…ç»™ä»»åŠ¡çš„å¯æ‰§è¡Œæ—¶é—´</p> <div class="language- extra-class"><pre class="language-text"><code>forceFrameRate = function(fps) {
    //fps: æ¯ç§’ä¼ è¾“é€Ÿç‡ï¼Œä¸æ”¯æŒå¼ºé€Ÿå¸§ 
    if (fps &lt; 0 || fps &gt; 125) {
      return;
    }
    if (fps &gt; 0) {
      yieldInterval = Math.floor(1000 / fps);
    } else {
      // é‡ç½®åˆå§‹å€¼
      yieldInterval = 5;
    }
};

</code></pre></div><h4 id="ä¼˜å…ˆçº§è°ƒåº¦"><a href="#ä¼˜å…ˆçº§è°ƒåº¦" class="header-anchor">#</a> ä¼˜å…ˆçº§è°ƒåº¦</h4> <p>Scheduleræ˜¯ç‹¬ç«‹äºReactçš„åŒ…ï¼Œæ‰€ä»¥å®ƒçš„ä¼˜å…ˆçº§ï¼ˆå­˜åœ¨5ç§ä¼˜å…ˆçº§ï¼‰ä¹Ÿæ˜¯ç‹¬ç«‹äºReactçš„ä¼˜å…ˆçº§çš„ã€‚å¯¹å¤–æš´éœ²äº†ä¸€ä¸ªæ–¹æ³• <code>unstable_runWithPriority</code></p> <div class="language- extra-class"><pre class="language-text"><code>function unstable_runWithPriority(priorityLevel, eventHandler) {
  switch (priorityLevel) {
    case ImmediatePriority:
    case UserBlockingPriority:
    case NormalPriority:
    case LowPriority:
    case IdlePriority:
      break;
    default:
      priorityLevel = NormalPriority;
  }

  var previousPriorityLevel = currentPriorityLevel;
  currentPriorityLevel = priorityLevel;

  try {
    return eventHandler();
  } finally {
    currentPriorityLevel = previousPriorityLevel;
  }
}
</code></pre></div><p>ä¸åŒä¼˜å…ˆçº§æ„å‘³ç€ä¸åŒæ—¶é•¿çš„ä»»åŠ¡è¿‡æœŸæ—¶é—´</p> <div class="language- extra-class"><pre class="language-text"><code>// Times out immediately
var IMMEDIATE_PRIORITY_TIMEOUT = -1;
// Eventually times out
var USER_BLOCKING_PRIORITY_TIMEOUT = 250;
var NORMAL_PRIORITY_TIMEOUT = 5000;
var LOW_PRIORITY_TIMEOUT = 10000;
// Never times out
var IDLE_PRIORITY_TIMEOUT = maxSigned31BitInt;


var timeout;
switch (priorityLevel) {
  case ImmediatePriority:
    timeout = IMMEDIATE_PRIORITY_TIMEOUT;
    break;
  case UserBlockingPriority:
    timeout = USER_BLOCKING_PRIORITY_TIMEOUT;
    break;
  case IdlePriority:
    timeout = IDLE_PRIORITY_TIMEOUT;
    break;
  case LowPriority:
    timeout = LOW_PRIORITY_TIMEOUT;
    break;
  case NormalPriority:
  default:
    timeout = NORMAL_PRIORITY_TIMEOUT;
    break;
}

var expirationTime = startTime + timeout;
</code></pre></div><p>å¦‚æœä¸€ä¸ªä»»åŠ¡çš„ä¼˜å…ˆçº§æ˜¯ImmediatePriorityï¼Œå¯¹åº”IMMEDIATE_PRIORITY_TIMEOUTä¸º-1ï¼Œé‚£ä¹ˆè¯¥ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´æ¯”å½“å‰æ—¶é—´è¿˜çŸ­ï¼Œè¡¨ç¤ºå®ƒå·²ç»è¿‡æœŸäº†ï¼Œéœ€è¦ç«‹å³è¢«æ‰§è¡Œã€‚</p> <h4 id="ä¸åŒä¼˜å…ˆçº§çš„æ’åºä»»åŠ¡"><a href="#ä¸åŒä¼˜å…ˆçº§çš„æ’åºä»»åŠ¡" class="header-anchor">#</a> ä¸åŒä¼˜å…ˆçº§çš„æ’åºä»»åŠ¡</h4> <p>Scueduler å­˜åœ¨ä¸¤ä¸ªé˜Ÿåˆ—</p> <ul><li>timerQueueï¼šä¿å­˜æœªå°±ç»ªä»»åŠ¡</li> <li>taskQueueï¼šä¿å­˜å·²å°±ç»ªä»»åŠ¡
æ¯å½“æœ‰æ–°çš„æœªå°±ç»ªçš„ä»»åŠ¡è¢«æ³¨å†Œï¼Œæˆ‘ä»¬å°†å…¶æ’å…¥åˆ°timerQueueï¼Œå¹¶æ ¹æ®å¼€å§‹æ—¶é—´é‡æ–°æ’åºã€‚
å½“timerQueueä¸­æœ‰ä»»åŠ¡å°±ç»ªï¼ˆcurrentTime &gt;= startTimeï¼‰,å–å‡ºåŠ å…¥åˆ°taskQueueã€‚
å–å‡ºtaskQueueä¸­æœ€æ—©è¿‡æœŸçš„ä»»åŠ¡å¹¶æ‰§è¡Œä»–ã€‚Schedulerä½¿ç”¨å°é¡¶å †å®ç°äº†ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚</li></ul> <p><code>å°é¡¶å †</code></p> <div class="language- extra-class"><pre class="language-text"><code>æ¯ä¸ªç»“ç‚¹çš„å€¼éƒ½å°äºæˆ–ç­‰äºå…¶å·¦å³å­©å­ç»“ç‚¹çš„å€¼
arr[i] &lt;= arr[2i+1] &amp;&amp; arr[i] &lt;= arr[2i+2]
</code></pre></div><p>å–å‡ºtaskQueueæœ€æ—©è¿‡æœŸä»»åŠ¡ï¼šæ³¨å†Œçš„å›è°ƒå‡½æ•°æ‰§è¡Œåçš„è¿”å›å€¼continuationCallbackä¸ºfunctionï¼Œä¼šå°†continuationCallbackä½œä¸ºå½“å‰ä»»åŠ¡çš„å›è°ƒå‡½æ•°ï¼Œå¦‚æœä¸æ˜¯funtionï¼Œåˆ™å°†å½“å‰è¢«æ‰§è¡Œçš„ä»»åŠ¡æ¸…é™¤taskQueueã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>const continuationCallback = callback(didUserCallbackTimeout);
currentTime = getCurrentTime();
if (typeof continuationCallback === 'function') {
  // continuationCallbackæ˜¯å‡½æ•°
  currentTask.callback = continuationCallback;
  markTaskYield(currentTask, currentTime);
} else {
  if (enableProfiling) {
    markTaskCompleted(currentTask, currentTime);
    currentTask.isQueued = false;
  }
  if (currentTask === peek(taskQueue)) {
    // å°†å½“å‰ä»»åŠ¡æ¸…é™¤
    pop(taskQueue);
  }
}
advanceTimers(currentTime);
</code></pre></div><h3 id="_02-laneæ¨¡å‹"><a href="#_02-laneæ¨¡å‹" class="header-anchor">#</a> 02. laneæ¨¡å‹</h3> <p>laneæ¨¡å‹ä½¿ç”¨31ä½çš„äºŒè¿›åˆ¶è¡¨ç¤º31æ¡èµ›é“ï¼Œä½æ•°è¶Šå°çš„èµ›é“ä¼˜å…ˆçº§è¶Šé«˜ï¼ŒæŸäº›ç›¸é‚»çš„èµ›é“æ‹¥æœ‰ç›¸åŒä¼˜å…ˆçº§ã€‚</p> <p>ä¼˜å…ˆçº§é€æ­¥é™ä½.</p> <p>ä»£è¡¨æ‰¹å¤„ç†çš„lanesï¼š åŒæ—¶å æ®å¥½å‡ ä¸ªèµ›é“</p> <div class="language- extra-class"><pre class="language-text"><code>export const NoLanes: Lanes = /*                        */ 0b0000000000000000000000000000000;
export const NoLane: Lane = /*                          */ 0b0000000000000000000000000000000;

export const SyncLane: Lane = /*                        */ 0b0000000000000000000000000000001;
export const SyncBatchedLane: Lane = /*                 */ 0b0000000000000000000000000000010;

export const InputDiscreteHydrationLane: Lane = /*      */ 0b0000000000000000000000000000100;
const InputDiscreteLanes: Lanes = /*                    */ 0b0000000000000000000000000011000;

const InputContinuousHydrationLane: Lane = /*           */ 0b0000000000000000000000000100000;
const InputContinuousLanes: Lanes = /*                  */ 0b0000000000000000000000011000000;

export const DefaultHydrationLane: Lane = /*            */ 0b0000000000000000000000100000000;
export const DefaultLanes: Lanes = /*                   */ 0b0000000000000000000111000000000;

const TransitionHydrationLane: Lane = /*                */ 0b0000000000000000001000000000000;
const TransitionLanes: Lanes = /*                       */ 0b0000000001111111110000000000000;

const RetryLanes: Lanes = /*                            */ 0b0000011110000000000000000000000;

export const SomeRetryLane: Lanes = /*                  */ 0b0000010000000000000000000000000;

export const SelectiveHydrationLane: Lane = /*          */ 0b0000100000000000000000000000000;

const NonIdleLanes = /*                                 */ 0b0000111111111111111111111111111;

export const IdleHydrationLane: Lane = /*               */ 0b0001000000000000000000000000000;
const IdleLanes: Lanes = /*                             */ 0b0110000000000000000000000000000;

export const OffscreenLane: Lane = /*                   */ 0b1000000000000000000000000000000;
</code></pre></div><p>InputDiscreteLanes æ˜¯â€œç”¨æˆ·äº¤äº’â€è§¦å‘æ›´æ–°ä¼šæ‹¥æœ‰çš„ä¼˜å…ˆçº§èŒƒå›´ã€‚</p> <p>DefaultLanesæ˜¯â€œè¯·æ±‚æ•°æ®è¿”å›åè§¦å‘æ›´æ–°â€æ‹¥æœ‰çš„ä¼˜å…ˆçº§èŒƒå›´ã€‚</p> <p>TransitionLanesæ˜¯Suspenseã€useTransitionã€useDeferredValueæ‹¥æœ‰çš„ä¼˜å…ˆçº§èŒƒå›´ã€‚</p> <h3 id="_03-ä½ä¸è¿ç®—"><a href="#_03-ä½ä¸è¿ç®—" class="header-anchor">#</a> 03. ä½ä¸è¿ç®—ï¼š</h3> <ul><li>å‰ç½®çŸ¥è¯†ï¼š</li></ul> <p>æ­£æ•°çš„åŸç ï¼Œåç ï¼Œè¡¥ç ä¸å˜
è´Ÿæ•°çš„åç æ˜¯å¯¹å…¶åŸç æŒ‰ä½å–åï¼Œç¬¦å·ä½ä¸å˜
è¡¥ç æ˜¯åœ¨å…¶åç åŸºç¡€ä¸Š+1</p> <p>ä¾‹å¦‚ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>let lanes =  0b011 -&gt; 00000011
   -lanes = -0b011 -&gt; 10000011(åŸç ) -&gt;11111100(åç ) -&gt; 11111101(è¡¥ç )
   lanes &amp; -lanes = 00000011 &amp;  11111101 -&gt; 00000001 -&gt; 1
</code></pre></div><p>ä½åˆå¹¶ä½è¿ç®—ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>export function mergeLanes(a: Lanes | Lane, b: Lanes | Lane): Lanes {
  return a | b;
}
</code></pre></div><p>laneå­˜åœ¨äº¤é›†ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>export function includesSomeLane(a: Lanes | Lane, b: Lanes | Lane) {
  return (a &amp; b) !== NoLane;
}
</code></pre></div><p>subSetæ˜¯setçš„å­é›†ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>export function isSubsetOfLanes(set: Lanes, subset: Lanes | Lane) {
  return (set &amp; subset) === subset;
}
</code></pre></div><p>å°†subsetä»setç§»é™¤ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>export function removeLanes(set: Lanes, subset: Lanes | Lane): Lanes {
  return set &amp; ~subset;
}
</code></pre></div><h3 id="_04-å¼‚æ­¥å¯ä¸­æ–­"><a href="#_04-å¼‚æ­¥å¯ä¸­æ–­" class="header-anchor">#</a> 04. å¼‚æ­¥å¯ä¸­æ–­</h3> <h4 id="batchedupdates-æ‰¹é‡æ›´æ–°-17ç‰ˆæœ¬"><a href="#batchedupdates-æ‰¹é‡æ›´æ–°-17ç‰ˆæœ¬" class="header-anchor">#</a> batchedUpdates æ‰¹é‡æ›´æ–°(17ç‰ˆæœ¬)</h4> <div class="language- extra-class"><pre class="language-text"><code>
                      wrappers (injected at creation time)
                                     +        +
                                     |        |
                   +-----------------|--------|--------------+
                   |                 v        |              |
                   |      +---------------+   |              |
                   |   +--|    wrapper1   |---|----+         |
                   |   |  +---------------+   v    |         |
                   |   |          +-------------+  |         |
                   |   |     +----|   wrapper2  |--------+   |
                   |   |     |    +-------------+  |     |   |
                   |   |     |                     |     |   |
                   |   v     v                     v     v   | wrapper
                   | +---+ +---+   +---------+   +---+ +---+ | invariants
perform(anyMethod) | |   | |   |   |         |   |   | |   | | maintained
+-----------------&gt;|-|---|-|---|--&gt;|anyMethod|---|---|-|---|-|--------&gt;
                   | |   | |   |   |         |   |   | |   | |
                   | |   | |   |   |         |   |   | |   | |
                   | |   | |   |   |         |   |   | |   | |
                   | +---+ +---+   +---------+   +---+ +---+ |
                   |  initialize                    close    |
                   +-----------------------------------------+

</code></pre></div><p>reactçš„ batchUpdateæ˜¯é€šè¿‡ <code>transaction</code>å®ç°çš„ã€‚<code>transaction</code>å¯¹ä¸€ä¸ªå‡½æ•°è¿›è¡ŒåŒ…è£…ï¼Œè®©react æœ‰æœºä¼šåœ¨ä¸€ä¸ªå‡½æ•°è¿è¡Œå‰åæ‰§è¡Œç‰¹å®šé€»è¾‘ï¼Œä»è€Œå®Œæˆæ•´ä¸ªbatchUpdateæµç¨‹çš„æ§åˆ¶ã€‚</p> <p><code>transaction</code>æ˜¯ç»™éœ€è¦æ‰§è¡Œçš„å‡½æ•°å°è£…äº†ä¸¤ä¸ª wrapperï¼Œæ¯ä¸ª wrapper éƒ½æœ‰ initialize å’Œ close æ–¹æ³•ã€‚å½“ä¸€ä¸ª transaction éœ€è¦æ‰§è¡Œï¼ˆperformï¼‰çš„æ—¶å€™ï¼Œä¼šå…ˆè°ƒç”¨å¯¹åº”çš„ initialize æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå½“ä¸€ä¸ª transaction æ‰§è¡Œå®Œæˆåï¼Œä¼šè°ƒç”¨å¯¹åº”çš„ close æ–¹æ³•ã€‚</p> <p>åœ¨<code>transaction</code>çš„initializeé˜¶æ®µï¼Œä¸€ä¸ªupdateQueueè¢«åˆ›å»ºã€‚åœ¨<code>transaction</code>ä¸­è°ƒç”¨setStateæ–¹æ³•æ—¶ï¼ŒçŠ¶æ€ä¸ä¼šç«‹å³åº”ç”¨ï¼Œè€Œæ˜¯è¢«æ¨å…¥åˆ°updateQueueä¸­ã€‚å‡½æ•°æ‰§è¡Œç»“æŸè¿›å…¥åˆ°<code>transaction</code>closeé˜¶æ®µï¼Œ updateQueueä¼šè¢«flushï¼Œæ­¤æ—¶æ–°çš„çŠ¶æ€ä¼šè¢«åº”ç”¨åˆ°ç»„ä»¶ä¸Šå¹¶è¿›è¡Œè™šæ‹Ÿdomæ›´æ–°ç­‰å·¥ä½œã€‚</p> <h4 id="é«˜ä¼˜å…ˆçº§æ›´æ–°æ’é˜Ÿ"><a href="#é«˜ä¼˜å…ˆçº§æ›´æ–°æ’é˜Ÿ" class="header-anchor">#</a> é«˜ä¼˜å…ˆçº§æ›´æ–°æ’é˜Ÿ</h4> <p>ä½ä¼˜å…ˆçº§ä»»åŠ¡åœ¨æ‰§è¡Œä¸­ï¼Œä¸€æ—¦æ¯”ä»–é«˜çš„ä¼˜å…ˆçº§ä»»åŠ¡åŠå“ªé‡Œï¼Œè¿™ä¸ªä½ä¼˜å…ˆçº§ä»»åŠ¡ä¼šè¢«ä¸­æ–­ï¼Œæ‰§è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œç­‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡ä¼šé‡æ–°æ‰§è¡Œã€‚</p> <p>å½“onClickè°ƒç”¨setStateæ—¶ï¼Œæ„å‘³ç€ç»„ä»¶å¯¹åº”çš„fiberèŠ‚ç‚¹äº§ç”Ÿäº†ä¸€ä¸ªæ›´æ–°ã€‚setStateå®é™…ä¸Šæ˜¯ç”Ÿæˆä¸€ä¸ªupdateå¯¹è±¡ï¼Œè°ƒç”¨ <code>enqueueSetState</code>ï¼Œå°†è¿™ä¸ªupdateå¯¹è±¡è¿æ¥åˆ°fiberèŠ‚ç‚¹çš„updateQueueé“¾è¡¨ä¸­.</p> <div class="language- extra-class"><pre class="language-text"><code>Component.prototype.setState = function(partialState, callback) {
  this.updater.enqueueSetState(this, partialState, callback, 'setState');
};
</code></pre></div><p><code>enqueueSetState</code>çš„ç›®çš„å°±æ˜¯åˆ›å»ºupdateå¯¹è±¡ï¼Œå°†å®ƒåŠ å…¥åˆ° fiberèŠ‚ç‚¹çš„updateé“¾è¡¨ <code>updateQueue</code>ï¼Œç„¶åå‘èµ·è°ƒåº¦ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>enqueueSetState(inst, payload, callback) {
    // è·å–å½“å‰è§¦å‘æ›´æ–°çš„fiberèŠ‚ç‚¹ã€‚instæ˜¯ç»„ä»¶å®ä¾‹
    const fiber = getInstance(inst);
    // eventTimeæ˜¯å½“å‰è§¦å‘æ›´æ–°çš„æ—¶é—´æˆ³
    const eventTime = requestEventTime();
    const suspenseConfig = requestCurrentSuspenseConfig();

    // è·å–æœ¬æ¬¡updateçš„ä¼˜å…ˆçº§
    const lane = requestUpdateLane(fiber, suspenseConfig);

    // åˆ›å»ºupdateå¯¹è±¡
    const update = createUpdate(eventTime, lane, suspenseConfig);

    // payloadå°±æ˜¯setStateçš„å‚æ•°ï¼Œå›è°ƒå‡½æ•°æˆ–è€…æ˜¯å¯¹è±¡çš„å½¢å¼ã€‚
    // å¤„ç†æ›´æ–°æ—¶å‚ä¸è®¡ç®—æ–°çŠ¶æ€çš„è¿‡ç¨‹
    update.payload = payload;

    // å°†updateæ”¾å…¥fiberçš„updateQueue
    enqueueUpdate(fiber, update);

    // å¼€å§‹è¿›è¡Œè°ƒåº¦
    scheduleUpdateOnFiber(fiber, lane, eventTime);
  }
</code></pre></div><ul><li>è®¡ç®—ä¼˜å…ˆçº§ <code>requestUpdateLane</code></li></ul> <p>äº‹ä»¶è§¦å‘æ—¶ï¼Œåˆæˆäº‹ä»¶æœºåˆ¶è°ƒç”¨schedulerä¸­çš„runWithPriorityå‡½æ•°ï¼Œç›®çš„æ˜¯ä»¥è¯¥äº¤äº’äº‹ä»¶å¯¹åº”çš„äº‹ä»¶ä¼˜å…ˆçº§å»æ´¾å‘çœŸæ­£çš„äº‹ä»¶æµç¨‹ã€‚runWithPriorityä¼šå°†äº‹ä»¶ä¼˜å…ˆçº§è½¬åŒ–ä¸ºschedulerå†…éƒ¨çš„ä¼˜å…ˆçº§å¹¶è®°å½•ä¸‹æ¥ã€‚å½“è°ƒç”¨requestUpdateLaneè®¡ç®—laneçš„æ—¶å€™ï¼Œä¼šå»è·å–schedulerä¸­çš„ä¼˜å…ˆçº§ï¼Œä»¥æ­¤ä½œä¸ºlaneè®¡ç®—çš„ä¾æ®ã€‚ï¼ˆfindUpdateLaneï¼‰</p> <ul><li>åˆ›å»º update å¯¹è±¡</li> <li>å°†updateæ”¾å…¥updateQueueä¸­</li> <li>scheduleUpdateOnFiber è¿›è¡Œè°ƒåº¦</li></ul> <h4 id="è°ƒåº¦å‡†å¤‡"><a href="#è°ƒåº¦å‡†å¤‡" class="header-anchor">#</a> è°ƒåº¦å‡†å¤‡</h4> <ol><li><p>æ£€æŸ¥æ˜¯å¦æœ‰æ— é™æ›´æ–°</p></li> <li><p>ä»äº§ç”Ÿæ›´æ–°çš„èŠ‚ç‚¹å¼€å§‹ä¸€ç›´å‘ä¸Šå¾ªç¯åˆ°rootï¼Œç›®çš„æ˜¯è¦å°†fiber.lanesä¸€ç›´å‘ä¸Šæ”¶é›†ï¼Œæ”¶é›†åˆ°çˆ¶çº§èŠ‚ç‚¹çš„childLanesä¸­ï¼ŒchildLanesæ˜¯è¯†åˆ«å­æ•°æ˜¯å¦æ›´æ–°çš„å…³é”®ã€‚å¦‚æœfiber.lanesä¸ä¸ºç©ºï¼Œè¯´æ˜è¯¥fiberèŠ‚ç‚¹æœ‰æ›´æ–°ã€‚fiber.childLanes åˆ¤æ–­å½“å‰å­æ ‘æ˜¯å¦æœ‰æ›´æ–°çš„ä¾æ®ï¼Œè‹¥æœ‰æ›´æ–°ï¼Œç»§ç»­å‘ä¸‹æ„å»ºï¼Œå¦åˆ™ç›´æ¥å¤ç”¨å·²æœ‰çš„fiberæ ‘ï¼Œå°±ä¸å¾€ä¸‹å¾ªç¯äº†ã€‚</p></li> <li><p>åœ¨rootä¸Šæ ‡è®°æ›´æ–°ï¼Œå°†updateçš„laneæ”¾åˆ°root.pendingLanesä¸­ï¼Œæ¯æ¬¡æ¸²æŸ“çš„ä¼˜å…ˆçº§åŸºå‡†ï¼šrenderLanesæ˜¯æ¥è‡ªäºroot.pendingLanesä¸­æœ€ç´§æ€¥çš„é‚£ä¸€éƒ¨åˆ†lanesã€‚</p></li></ol> <div class="language- extra-class"><pre class="language-text"><code>function scheduleUpdateOnFiber(
  fiber: Fiber,
  lane: Lane,
  eventTime: number,
) {
  // ç¬¬ä¸€æ­¥ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ— é™æ›´æ–°
  checkForNestedUpdates();

  ...
  // ç¬¬äºŒæ­¥ï¼Œå‘ä¸Šæ”¶é›†fiber.childLanes
  const root = markUpdateLaneFromFiberToRoot(fiber, lane);

  ...

  // ç¬¬ä¸‰æ­¥ï¼Œåœ¨rootä¸Šæ ‡è®°æ›´æ–°ï¼Œå°†updateçš„laneæ”¾åˆ°root.pendingLanes
  markRootUpdated(root, lane, eventTime);

  ...

  // æ ¹æ®Schedulerçš„ä¼˜å…ˆçº§è·å–åˆ°å¯¹åº”çš„Reactä¼˜å…ˆçº§
  const priorityLevel = getCurrentPriorityLevel();

  if (lane === SyncLane) {
    // æœ¬æ¬¡æ›´æ–°æ˜¯åŒæ­¥çš„ï¼Œä¾‹å¦‚ä¼ ç»Ÿçš„åŒæ­¥æ¸²æŸ“æ¨¡å¼
    if (
      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;
      (executionContext &amp; (RenderContext | CommitContext)) === NoContext
    ) {
      // å¦‚æœæ˜¯æœ¬æ¬¡æ›´æ–°æ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸”å½“å‰è¿˜æœªæ¸²æŸ“ï¼Œæ„å‘³ç€ä¸»çº¿ç¨‹ç©ºé—²ï¼Œå¹¶æ²¡æœ‰Reactçš„æ›´æ–°ä»»åŠ¡åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆè°ƒç”¨performSyncWorkOnRootå¼€å§‹æ‰§è¡ŒåŒæ­¥ä»»åŠ¡
      // ...
      performSyncWorkOnRoot(root);
    } else {
      // å¦‚æœæ˜¯æœ¬æ¬¡æ›´æ–°æ˜¯åŒæ­¥çš„ï¼Œä¸è¿‡å½“å‰æœ‰Reactæ›´æ–°ä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œè€Œä¸”å› ä¸ºæ— æ³•æ‰“æ–­ï¼Œæ‰€ä»¥è°ƒç”¨ensureRootIsScheduled ç›®çš„æ˜¯å»å¤ç”¨å·²ç»åœ¨æ›´æ–°çš„ä»»åŠ¡ï¼Œè®©è¿™ä¸ªå·²æœ‰çš„ä»»åŠ¡æŠŠè¿™æ¬¡æ›´æ–°é¡ºä¾¿åšäº†
      ensureRootIsScheduled(root, eventTime);
      ...
    }
  } else {

    ...

    // Schedule other updates after in case the callback is sync.
    // å¦‚æœæ˜¯æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼Œè°ƒç”¨ensureRootIsScheduledå»è¿›å…¥å¼‚æ­¥è°ƒåº¦
    ensureRootIsScheduled(root, eventTime);
    schedulePendingInteractions(root, lane);
  }

  ...
}
</code></pre></div><p>scheduleUpdateOnFiberæœ€ç»ˆä¼šè°ƒç”¨<code>ensureRootIsScheduled</code>æ¥è°ƒåº¦ã€‚
ä¸€ä¸ªupdateçš„äº§ç”Ÿæœ€ç»ˆä¼šä½¿Reactåœ¨å†…å­˜ä¸­æ ¹æ®ç°æœ‰çš„fiberæ ‘æ„å»ºä¸€æ£µæ–°çš„fiberæ ‘ï¼Œæ–°çš„stateçš„è®¡ç®—ã€diffæ“ä½œã€ä»¥åŠä¸€äº›ç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨ï¼Œéƒ½ä¼šåœ¨è¿™ä¸ªæ„å»ºè¿‡ç¨‹ä¸­è¿›è¡Œã€‚è¿™ä¸ªæ•´ä½“çš„æ„å»ºå·¥ä½œè¢«ç§°ä¸ºrenderé˜¶æ®µï¼Œè¿™ä¸ªrenderé˜¶æ®µæ•´ä½“å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„Reactæ›´æ–°ä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡å¯ä»¥çœ‹ä½œæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨concurrentæ¨¡å¼ä¸‹å°±æ˜¯performConcurrentWorkOnRootï¼Œæ›´æ–°ä»»åŠ¡çš„è°ƒåº¦å¯ä»¥çœ‹æˆæ˜¯è¿™ä¸ªå‡½æ•°è¢«scheduleræŒ‰ç…§ä»»åŠ¡ä¼˜å…ˆçº§å®‰æ’å®ƒä½•æ—¶æ‰§è¡Œã€‚</p> <h4 id="reactä»»åŠ¡çš„æœ¬è´¨"><a href="#reactä»»åŠ¡çš„æœ¬è´¨" class="header-anchor">#</a> reactä»»åŠ¡çš„æœ¬è´¨</h4> <p>ä¸€ä¸ªupdateçš„äº§ç”Ÿæœ€ç»ˆä¼šä½¿reactåœ¨å†…å­˜ä¸­ æ ¹æ®ç°æœ‰çš„fiberæ ‘æ„å»ºä¸€é¢—æ–°çš„fiberæ ‘ï¼Œæ–°çš„stateè®¡ç®—ï¼Œdiffæ“ä½œï¼Œè¿˜æœ‰ä¸€äº›å£°æ˜å‘¨æœŸçš„è°ƒç”¨ï¼Œéƒ½ä¼šåœ¨è¿™ä¸ªæ„å»ºè¿‡ç¨‹ä¸­è¿›è¡Œã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„renderé˜¶æ®µã€‚ renderé˜¶æ®µå°±æ˜¯ä¸€ä¸ªå®Œæˆçš„react æ›´æ–°ä»»åŠ¡ã€‚ åœ¨concurrentæ¨¡å¼ä¸‹ï¼Œå°±æ˜¯performConcurrentWorkOnRootï¼Œæ›´æ–°ä»»åŠ¡çš„è°ƒåº¦æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºè¿™ä¸ªå‡½æ•°è¢«scheduler æŒ‰ç…§ä»»åŠ¡ä¼˜å…ˆçº§å®‰æ’å®ƒä½•æ—¶æ‰§è¡Œã€‚</p> <p>æ¯å½“æœ‰æ–°çš„ä»»åŠ¡æ¥çš„æ—¶å€™ï¼Œä¼šè¢«æŒ‚è½½åˆ°rootèŠ‚ç‚¹çš„<code>callbackNode</code>å±æ€§ä¸Šï¼Œè¡¨ç¤ºå½“å‰æœ‰ä»»åŠ¡è¢«è°ƒåº¦äº†ï¼Œå¦å¤–å°†ä»»åŠ¡ä¼˜å…ˆçº§å­˜å‚¨åˆ°rootçš„<code>callbackPriority</code>ä¸Š</p> <h4 id="ä»»åŠ¡è°ƒåº¦åè°ƒ-ensurerootisscheduled"><a href="#ä»»åŠ¡è°ƒåº¦åè°ƒ-ensurerootisscheduled" class="header-anchor">#</a> ä»»åŠ¡è°ƒåº¦åè°ƒ - ensureRootIsScheduled</h4> <p>ä¸»è¦èŒèƒ½ï¼š</p> <ul><li>è·å– <code>root.callbackNode</code> å³æ—§ä»»åŠ¡</li> <li>æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Œå°†è¿‡æœŸä»»åŠ¡æ”¾å…¥<code>root.expriedLanes</code>,ç›®çš„æ˜¯è®©è¿‡æœŸä»»åŠ¡èƒ½å¤Ÿä»¥åŒæ­¥ä¼˜å…ˆçº§å»è¿›è¡Œè°ƒåº¦ï¼ˆç«‹å³æ‰§è¡Œï¼‰</li> <li>è·å–renderLanes(ä¼˜å…ˆä»<code>root.expriedLanes</code>è·å–)ï¼Œå¦‚æœrenderLanesæ˜¯ç©ºçš„ï¼Œè¯´æ˜ä¸éœ€è¦è°ƒåº¦ï¼Œç›´æ¥return</li> <li>è·å–æœ¬æ¬¡ä¼˜å…ˆçº§ï¼Œå³æ–°çš„ä¼˜å…ˆçº§ï¼Œ<code>newCallbackPriority</code></li></ul> <p>åè°ƒè°ƒåº¦è¿‡ç¨‹ï¼š</p> <ul><li><p>é¦–å…ˆç¡®è®¤æ˜¯å¦å‘èµ·è°ƒåº¦ï¼Œé€šè¿‡å¯¹æ¯”æ–°æ—§ä»»åŠ¡ä¼˜å…ˆçº§æ˜¯å¦ç›¸ç­‰</p> <ul><li>ç›¸ç­‰ï¼šæ— éœ€è°ƒåº¦ï¼Œç›´æ¥å¤ç”¨æ—§ä»»åŠ¡ï¼Œè®©æ—§ä»»åŠ¡åœ¨å¤„ç†æ›´æ–°çš„æ—¶å€™è¿å¸¦æ–°ä»»åŠ¡ä¸€èµ·åš</li> <li>ä¸ç›¸ç­‰ï¼šè¯´æ˜æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§é«˜äºæ—§ä»»åŠ¡ï¼Œ <code>é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿ</code>ï¼Œéœ€è¦æŠŠæ—§ä»»åŠ¡å–æ¶ˆ</li></ul> <p>è¿™æ˜¯å› ä¸ºæ¯æ¬¡è°ƒåº¦å»è·å–ä»»åŠ¡ä¼˜å…ˆçº§ï¼ˆrenderLanesï¼‰çš„æ—¶å€™ï¼Œéƒ½åªè·å–root.pendingLanesä¸­æœ€ç´§æ€¥çš„é‚£éƒ¨åˆ†laneså¯¹åº”çš„ä¼˜å…ˆçº§ï¼Œä½ä¼˜å…ˆçº§çš„updateæŒæœ‰çš„laneå¯¹åº”çš„ä¼˜å…ˆçº§æ˜¯æ— æ³•è¢«è·å–åˆ°çš„ã€‚é€šè¿‡è¿™ç§åŠæ³•ï¼Œå¯ä»¥å°†æ¥è‡ªåŒä¸€äº‹ä»¶ä¸­çš„å¤šä¸ªæ›´æ–°æ”¶æ•›åˆ°ä¸€ä¸ªä»»åŠ¡ä¸­å»æ‰§è¡Œï¼Œé€šä¿—ç†è§£å°±æ˜¯åŒä¸€ä¸ªäº‹ä»¶è§¦å‘çš„å¤šæ¬¡æ›´æ–°çš„ä¼˜å…ˆçº§æ˜¯ä¸€æ ·çš„ï¼Œæ²¡å¿…è¦å‘èµ·å¤šæ¬¡ä»»åŠ¡è°ƒåº¦ã€‚ä¾‹å¦‚åœ¨ä¸€ä¸ªäº‹ä»¶ä¸­å¤šæ¬¡è°ƒç”¨setState,åªå¼•èµ·ä¸€æ¬¡è°ƒåº¦ï¼Œåç»­è°ƒåº¦ä¸ç¬¬ä¸€æ¬¡è°ƒåº¦ä¼˜å…ˆçº§ä¸€è‡´ï¼Œç›´æ¥å¤ç”¨äº†ã€‚</p></li> <li><p>å‘èµ·è°ƒåº¦ï¼šæŸ¥çœ‹æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§</p> <ul><li>åŒæ­¥ä¼˜å…ˆçº§(legacy æ¨¡å¼)ï¼šè°ƒç”¨ <code>scheduleSyncCallback</code>å»åŒæ­¥æ‰§è¡Œä»»åŠ¡</li> <li>åŒæ­¥æ‰¹é‡æ‰§è¡Œï¼ˆblocking æ¨¡å¼ï¼‰ï¼šè°ƒç”¨ <code>scheduleCallback</code> ä»¥åŒæ­¥ä»»åŠ¡ä¼˜å…ˆçº§ï¼ˆç«‹å³è°ƒç”¨ï¼‰è°ƒåº¦</li> <li>å±äºconCurrentä¼˜å…ˆçº§ï¼ˆconCurrent æ¨¡å¼ï¼‰ï¼šè°ƒç”¨<code>scheduleCallback</code>å°†ä»»åŠ¡ä»¥ä¸Šé¢è·å–åˆ°çš„æ–°ä»»åŠ¡ä¼˜å…ˆçº§å»åŠ å…¥è°ƒåº¦ã€‚</li></ul></li></ul> <div class="language- extra-class"><pre class="language-text"><code>function ensureRootIsScheduled(root: FiberRoot, currentTime: number) {
  // è·å–æ—§ä»»åŠ¡
  const existingCallbackNode = root.callbackNode;

  // è®°å½•ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¿‡æœŸä»»åŠ¡ï¼Œæœ‰åˆ™ç«‹å³å°†å®ƒæ”¾åˆ°root.expiredLanesï¼Œ
  // ä¾¿äºæ¥ä¸‹æ¥å°†è¿™ä¸ªä»»åŠ¡ä»¥åŒæ­¥æ¨¡å¼ç«‹å³è°ƒåº¦
  markStarvedLanesAsExpired(root, currentTime);

  // è·å–renderLanes
  const nextLanes = getNextLanes(
    root,
    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes,
  );

  // è·å–renderLaneså¯¹åº”çš„ä»»åŠ¡ä¼˜å…ˆçº§
  const newCallbackPriority = returnNextLanesPriority();

  if (nextLanes === NoLanes) {
    // å¦‚æœæ¸²æŸ“ä¼˜å…ˆçº§ä¸ºç©ºï¼Œåˆ™ä¸éœ€è¦è°ƒåº¦
    if (existingCallbackNode !== null) {
      cancelCallback(existingCallbackNode);
      root.callbackNode = null;
      root.callbackPriority = NoLanePriority;
    }
    return;
  }

  // å¦‚æœå­˜åœ¨æ—§ä»»åŠ¡ï¼Œé‚£ä¹ˆçœ‹ä¸€ä¸‹èƒ½å¦å¤ç”¨
  if (existingCallbackNode !== null) {

    // è·å–æ—§ä»»åŠ¡çš„ä¼˜å…ˆçº§
    const existingCallbackPriority = root.callbackPriority;

    // å¦‚æœæ–°æ—§ä»»åŠ¡çš„ä¼˜å…ˆçº§ç›¸åŒï¼Œåˆ™æ— éœ€è°ƒåº¦
    if (existingCallbackPriority === newCallbackPriority) {
      return;
    }
    // ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§é«˜äºæ—§ä»»åŠ¡çš„ä¼˜å…ˆçº§
    // å–æ¶ˆæ‰æ—§ä»»åŠ¡ï¼Œå®ç°é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿ
    cancelCallback(existingCallbackNode);
  }

  // è°ƒåº¦ä¸€ä¸ªæ–°ä»»åŠ¡
  let newCallbackNode;
  if (newCallbackPriority === SyncLanePriority) {

    // è‹¥æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§ä¸ºåŒæ­¥ä¼˜å…ˆçº§ï¼Œåˆ™åŒæ­¥è°ƒåº¦ï¼Œä¼ ç»Ÿçš„åŒæ­¥æ¸²æŸ“å’Œè¿‡æœŸä»»åŠ¡ä¼šèµ°è¿™é‡Œ
    newCallbackNode = scheduleSyncCallback(
      performSyncWorkOnRoot.bind(null, root),
    );
  } else if (newCallbackPriority === SyncBatchedLanePriority) {

    // åŒæ­¥æ¨¡å¼åˆ°concurrentæ¨¡å¼çš„è¿‡æ¸¡æ¨¡å¼ï¼šblockingæ¨¡å¼ä¼šèµ°è¿™é‡Œ
    newCallbackNode = scheduleCallback(
      ImmediateSchedulerPriority,
      performSyncWorkOnRoot.bind(null, root),
    );
  } else {
    // concurrentæ¨¡å¼çš„æ¸²æŸ“ä¼šèµ°è¿™é‡Œ

    // æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§è·å–Schedulerçš„è°ƒåº¦ä¼˜å…ˆçº§
    const schedulerPriorityLevel = lanePriorityToSchedulerPriority(
      newCallbackPriority,
    );

    // è®¡ç®—å‡ºè°ƒåº¦ä¼˜å…ˆçº§ä¹‹åï¼Œå¼€å§‹è®©Schedulerè°ƒåº¦Reactçš„æ›´æ–°ä»»åŠ¡
    newCallbackNode = scheduleCallback(
      schedulerPriorityLevel,
      performConcurrentWorkOnRoot.bind(null, root),
    );
  }

  // æ›´æ–°rootä¸Šçš„ä»»åŠ¡ä¼˜å…ˆçº§å’Œä»»åŠ¡ï¼Œä»¥ä¾¿ä¸‹æ¬¡å‘èµ·è°ƒåº¦æ—¶å€™å¯ä»¥è·å–åˆ°
  root.callbackPriority = newCallbackPriority;
  root.callbackNode = newCallbackNode;
}
</code></pre></div><p><code>ensureRootIsScheduled</code> åœ¨ä»»åŠ¡è°ƒåº¦å±‚é¢æ•´åˆäº†é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„æ’é˜Ÿå’Œä»»åŠ¡é¥¥é¥¿é—®é¢˜çš„å…³é”®é€»è¾‘ã€‚</p> <p>é¥¥é¥¿é—®é¢˜ï¼šæ˜¯æŒ‡ä½ä¼˜å…ˆçº§ä»»åŠ¡å§‹ç»ˆè¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­,å¯¼è‡´æ²¡æœ‰æ—¶é—´æ‰§è¡Œã€‚</p> <p>é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡é‡åšçš„æ•´ä¸ªè¿‡ç¨‹å…±æœ‰å››ä¸ªå…³é”®ç‚¹ï¼š</p> <ul><li>ensureRootIsScheduledå–æ¶ˆå·²æœ‰çš„ä½ä¼˜å…ˆçº§æ›´æ–°ä»»åŠ¡ï¼Œé‡æ–°è°ƒåº¦ä¸€ä¸ªä»»åŠ¡å»åšé«˜ä¼˜å…ˆçº§æ›´æ–°ï¼Œå¹¶ä»¥root.pendingLanesä¸­æœ€é‡è¦çš„é‚£éƒ¨åˆ†lanesä½œä¸ºæ¸²æŸ“ä¼˜å…ˆçº§</li> <li>æ‰§è¡Œæ›´æ–°ä»»åŠ¡æ—¶è·³è¿‡updateQueueä¸­çš„ä½ä¼˜å…ˆçº§updateï¼Œå¹¶å°†å®ƒçš„laneæ ‡è®°åˆ°fiber.lanesä¸­ã€‚</li> <li>fiberèŠ‚ç‚¹çš„completeé˜¶æ®µæ”¶é›†fiber.lanesåˆ°çˆ¶çº§fiberçš„childLanesï¼Œä¸€ç›´åˆ°rootã€‚</li> <li>commité˜¶æ®µå°†æ‰€æœ‰root.childLanesè¿åŒroot.lanesä¸€å¹¶èµ‹å€¼ç»™root.pendingLanesã€‚</li> <li>commité˜¶æ®µçš„æœ€åé‡æ–°å‘èµ·è°ƒåº¦ï¼Œï¼ˆensureRootIsScheduledå®ç°ï¼‰é‡æ–°èµ°ä¸€éè°ƒåº¦æµç¨‹ï¼Œç¡®ä¿ä½ä¼˜å…ˆçº§ä»»åŠ¡è¢«æ‰§è¡Œã€‚</li></ul> <h3 id="_05-suspenseå®ç°"><a href="#_05-suspenseå®ç°" class="header-anchor">#</a> 05. Suspenseå®ç°</h3> <p>å¤„ç†æµç¨‹:</p> <ul><li>Suspense è®©å­ç»„ä»¶åœ¨æ¸²æŸ“ä¹‹å‰è¿›è¡Œç­‰å¾…ï¼Œå¹¶åœ¨ç­‰å¾…æ—¶æ˜¾ç¤º fallback çš„å†…å®¹</li> <li>Suspense å†…çš„ç»„ä»¶å­æ ‘æ¯”ç»„ä»¶æ ‘çš„å…¶ä»–éƒ¨åˆ†æ‹¥æœ‰æ›´ä½çš„ä¼˜å…ˆçº§</li></ul> <p>æ‰§è¡Œæµç¨‹ï¼š</p> <ul><li>åœ¨ <code>render</code> å‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨å¼‚æ­¥è¯·æ±‚æ•°æ®</li> <li>react ä¼šä»æˆ‘ä»¬çš„ç¼“å­˜ä¸­è¯»å–,å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿›è¡Œ render,å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œä¼šæŠ›å‡ºä¸€ä¸ª promise å¼‚å¸¸ã€‚å½“ promise å®Œæˆåï¼Œreact ä¼šé‡æ–°è¿›è¡Œ renderï¼ŒæŠŠæ•°æ®å±•ç¤ºå‡ºæ¥ï¼Œå®Œå…¨åŒæ­¥å†™æ³•ï¼Œæ²¡æœ‰ä»»ä½•å¼‚æ­¥ callbackã€‚</li></ul> <h4 id="_01ç®€æ˜“ç‰ˆä»£ç å®ç°"><a href="#_01ç®€æ˜“ç‰ˆä»£ç å®ç°" class="header-anchor">#</a> 01ç®€æ˜“ç‰ˆä»£ç å®ç°ï¼š</h4> <ol><li>å­ç»„ä»¶æ²¡æœ‰åŠ è½½å®Œæˆæ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ª promise å¼‚å¸¸</li> <li>ç›‘å¬ promiseï¼ŒçŠ¶æ€å˜æ›´åï¼Œæ›´æ–° stateï¼Œè§¦å‘ç»„ä»¶æ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“å­ç»„ä»¶</li> <li>å±•ç¤ºå­ç»„ä»¶å†…å®¹</li></ol> <div class="language- extra-class"><pre class="language-text"><code>export default class Suspense extends React.Component {
    state = {
        loading: false,
    };

    componentDidCatch(error) {
        if (error &amp;&amp; typeof error.then === &quot;function&quot;) {
            error.then(() =&gt; {
                this.setState({ loading: true });
            });
            this.setState({ loading: false });
        }
    }

    render() {
        const { fallback, children } = this.props;
        const { loading } = this.state;
        return loading ? fallback : children;
    }
}
</code></pre></div><h4 id="_02ç®€æ˜“ç‰ˆä»£ç å®ç°"><a href="#_02ç®€æ˜“ç‰ˆä»£ç å®ç°" class="header-anchor">#</a> 02ç®€æ˜“ç‰ˆä»£ç å®ç°ï¼š</h4> <p>é—®é¢˜æ˜¯æˆ‘ä»¬åœ¨ç¼–å†™ç»„ä»¶çš„æ—¶å€™ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨async await, ç»“åˆsuspenseåŸç†ï¼Œå°è£…ä¸€ä¸ªpromiseï¼Œè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬å°† promise ä½œä¸ºå¼‚å¸¸æŠ›å‡ºï¼Œè¯·æ±‚å®Œæˆå±•ç¤ºç»“æœã€‚</p> <p>å®šä¹‰ä¸€ä¸ªWrapPromise å‡½æ•°ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>function WrapPromise (promise) {
  let status = &quot;pending&quot;;
    let result;
    let suspender = promise.then(
        (res) =&gt; {
            status = &quot;success&quot;;
            result = res;
        },
        (error) =&gt; {
            status = &quot;error&quot;;
            result = error;
        }
    );
  return {
        exec() {
            if (status === &quot;pending&quot;) {
                throw suspender;
            } else if (status === &quot;error&quot;) {
                throw result;
            } else if (status === &quot;success&quot;) {
                return result;
            }
        },
  };
}
</code></pre></div><h4 id="suspenselist"><a href="#suspenselist" class="header-anchor">#</a> SuspenseList</h4> <h5 id="ä¸‰ä¸ªå±æ€§"><a href="#ä¸‰ä¸ªå±æ€§" class="header-anchor">#</a> ä¸‰ä¸ªå±æ€§</h5> <ul><li>revealOrder: å­ Suspense çš„åŠ è½½é¡ºåº
<ul><li>forwards: ä»å‰å‘åå±•ç¤ºï¼Œæ— è®ºè¯·æ±‚çš„é€Ÿåº¦å¿«æ…¢éƒ½ä¼šç­‰å‰é¢çš„å…ˆå±•ç¤º</li> <li>backwards: ä»åå‘å‰å±•ç¤ºï¼Œæ— è®ºè¯·æ±‚çš„é€Ÿåº¦å¿«æ…¢éƒ½ä¼šç­‰åé¢çš„å…ˆå±•ç¤º</li> <li>together: æ‰€æœ‰çš„ Suspense éƒ½å‡†å¤‡å¥½ä¹‹ååŒæ—¶æ˜¾ç¤º</li></ul></li> <li>tail: æŒ‡å®šå¦‚ä½•æ˜¾ç¤º SuspenseList ä¸­æœªå‡†å¤‡å¥½çš„ Suspense
<ul><li>ä¸è®¾ç½®ï¼šé»˜è®¤åŠ è½½æ‰€æœ‰ Suspense å¯¹åº”çš„ fallback</li> <li>collapsedï¼šä»…å±•ç¤ºåˆ—è¡¨ä¸­ä¸‹ä¸€ä¸ª Suspense çš„ fallback</li> <li>hidden: æœªå‡†å¤‡å¥½çš„é¡¹ç›®ä¸é™æ—¶ä»»ä½•ä¿¡æ¯</li></ul></li> <li>children: å­å…ƒç´ 
<ul><li>å­å…ƒç´ å¯ä»¥æ˜¯ä»»æ„ React å…ƒç´ </li></ul></li></ul> <p>å½“å­å…ƒç´ ä¸­åŒ…å«é Suspense ç»„ä»¶æ—¶ï¼Œä¸”æœªè®¾ç½® tail å±æ€§ï¼Œé‚£ä¹ˆæ­¤æ—¶æ‰€æœ‰çš„ Suspense å…ƒç´ å¿…å®šæ˜¯åŒæ—¶åŠ è½½ï¼Œè®¾ç½® revealOrder å±æ€§ä¹Ÿæ— æ•ˆã€‚å½“è®¾ç½® tail å±æ€§åï¼Œæ— è®ºæ˜¯ collapsed è¿˜æ˜¯ hiddenï¼ŒrevealOrder å±æ€§å³å¯ç”Ÿæ•ˆ
å­å…ƒç´ ä¸­å¤šä¸ª Suspense ä¸ä¼šç›¸äº’é˜»å¡ã€‚</p> <p>SuspenseListä»…å¯¹æœ€è¿‘çš„ç»„ä»¶å’Œå…¶ä¸‹æ–¹çš„Suspenseç»„ä»¶SuspenseListè¿›è¡Œæ“ä½œã€‚å®ƒä¸ä¼šæœç´¢æ¯”ä¸€å±‚æ›´æ·±çš„è¾¹ç•Œã€‚ä½†æ˜¯ï¼Œå¯ä»¥å°†å¤šä¸ªSuspenseListç»„ä»¶ç›¸äº’åµŒå¥—ä»¥æ„å»ºç½‘æ ¼ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;SuspenseList revealOrder=&quot;forwards&quot; tail=&quot;collapsed&quot;&gt;
  &lt;Suspense fallback={&lt;div&gt;Loading...&lt;/div&gt;}&gt;
    &lt;User id={1} /&gt;
  &lt;/Suspense&gt;
  &lt;Suspense fallback={&lt;div&gt;Loading...&lt;/div&gt;}&gt;
    &lt;User id={3} /&gt;
  &lt;/Suspense&gt;
  &lt;Suspense fallback={&lt;div&gt;Loading...&lt;/div&gt;}&gt;
    &lt;User id={5} /&gt;
  &lt;/Suspense&gt;
&lt;/SuspenseList&gt;
</code></pre></div></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=react" title="æ ‡ç­¾">#react</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/f09444/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">react hook</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/f09444/" class="prev">react hook</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">æœ€è¿‘æ›´æ–°</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ad8265/"><div>
            Dart
            <!----></div></a> <span class="date">06-12</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/a158f0/"><div>
            å®‰è£…
            <!----></div></a> <span class="date">06-12</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5be7db/"><div>
            æµè§ˆå™¨åŸç†
            <!----></div></a> <span class="date">05-31</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">æ›´å¤šæ–‡ç« &gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1730129114@qq.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wshuhua" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/my/m/music/playlist?id=7141103351" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2022-2022
    <span>Wsh  | <a href="https://github.com/wshuhua" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a43f69ea.js" defer></script><script src="/assets/js/2.dc8a2400.js" defer></script><script src="/assets/js/57.e410f001.js" defer></script>
  </body>
</html>
